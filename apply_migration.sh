#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ FINAL_MIGRATION.sql –∫ Railway –ë–î
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./apply_migration.sh "postgres://user:password@host:port/database"

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

MIGRATION_FILE="FINAL_MIGRATION.sql"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
if [ $# -eq 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  $0 \"postgres://user:password@host:port/database\""
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä:"
    echo "  $0 \"postgresql://postgres:password@containers-us-west-1.railway.app:5432/railway\""
    echo ""
    echo "–ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤ Railway:"
    echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –Ω–∞ Railway"
    echo "2. –í—ã–±–µ—Ä–∏—Ç–µ PostgreSQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
    echo "3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª 'Variables'"
    echo "4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ DATABASE_URL"
    exit 1
fi

DATABASE_URL="$1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
if [ ! -f "$MIGRATION_FILE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ $MIGRATION_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "üöÄ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∫ Railway –ë–î..."
echo "üìÅ –§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏: $MIGRATION_FILE"
echo "üîó –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${DATABASE_URL%%@*}@***"  # –°–∫—Ä—ã–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –≤ –ª–æ–≥–∞—Ö
echo ""

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é
echo "‚è≥ –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é..."
if psql "$DATABASE_URL" -f "$MIGRATION_FILE"; then
    echo ""
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!"
    echo ""
    echo "üìä –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:"
    echo "  ‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ admin_coins –≤ —Ç–∞–±–ª–∏—Ü—É users"
    echo "  ‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω—Å–∫–∏–µ –±–æ–Ω—É—Å—ã –¥–ª—è ID = 5015100177: 30 –≤–∏–¥–µ–æ, 50 —Ñ–æ—Ç–æ, 10 –ø—Ä–∏–º–µ—Ä–æ—á–Ω—ã—Ö, 500 –∞–¥–º–∏–Ω—Å–∫–∏—Ö –º–æ–Ω–µ—Ç–æ–∫"
    echo "  ‚Ä¢ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –±–æ–Ω—É—Å–∞–º–∏ (2/3/1) –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ (2/2/2)"
    echo ""
    echo "üéâ –°–∏—Å—Ç–µ–º–∞ –±–æ–Ω—É—Å–æ–≤ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "  ‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
    echo "  ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
    echo "  ‚Ä¢ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î"
    exit 1
fi
