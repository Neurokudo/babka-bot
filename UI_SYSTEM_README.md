# –ù–æ–≤–∞—è UI —Å–∏—Å—Ç–µ–º–∞ –±–æ—Ç–∞

## –û–±–∑–æ—Ä

–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–º–µ–Ω—è–µ—Ç —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ callback-–æ–≤.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
app/
‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # –≠–∫—Å–ø–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ texts.py             # –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ callbacks.py         # –°–∏—Å—Ç–µ–º–∞ callback –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ menu_schema.py       # –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞ –º–µ–Ω—é
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py         # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä
‚îÇ   ‚îî‚îÄ‚îÄ legacy_mapping.py    # –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö callback-–æ–≤
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # –≠–∫—Å–ø–æ—Ä—Ç —Ä–æ—É—Ç–µ—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ router.py            # –ï–¥–∏–Ω—ã–π —Ä–æ—É—Ç–µ—Ä callback-–æ–≤
scripts/
‚îú‚îÄ‚îÄ dump_flow.py             # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º Mermaid
docs/                        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
test_ui_system.py           # –¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã
```

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞ –º–µ–Ω—é
- –í—Å–µ —ç–∫—Ä–∞–Ω—ã –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã –æ–ø–∏—Å–∞–Ω—ã –≤ `menu_schema.py`
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —ç–∫—Ä–∞–Ω—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã

### ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
- –í—Å–µ —Ç–µ–∫—Å—Ç—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ (`texts.py`)
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

### ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ callback –¥–∞–Ω–Ω—ã–µ
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –¥–æ 64 –±–∞–π—Ç
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ callback-–∞–º–∏

### ‚úÖ –ï–¥–∏–Ω—ã–π —Ä–æ—É—Ç–µ—Ä
- –í—Å–µ callback-—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º Mermaid
- –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è callback-–æ–≤
- –°–≤–æ–¥–∫–∞ –ø–æ —É–∑–ª–∞–º –º–µ–Ω—é

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
python3 test_ui_system.py
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
```bash
python3 scripts/dump_flow.py
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py
```python
from app.handlers.router import register_router
from app.ui.keyboards import build_keyboard_with_description
from app.ui.texts import t

# –í create_app() –∑–∞–º–µ–Ω–∏—Ç–µ:
# app.add_handler(CallbackQueryHandler(on_cb))
register_router(app)  # –ù–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä:
text, keyboard = build_keyboard_with_description("root")
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –¢–µ–∫—Å—Ç—ã (`texts.py`)
```python
from app.ui.texts import t

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
text = t("menu.title")  # "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"

# –° —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
text = t("desc.transforms", coins=100)  # "üí∞ –£ —Ç–µ–±—è: 100 –º–æ–Ω–µ—Ç–æ–∫"
```

### Callback –¥–∞–Ω–Ω—ã–µ (`callbacks.py`)
```python
from app.ui.callbacks import Cb, Actions

# –°–æ–∑–¥–∞–Ω–∏–µ callback
cb = Cb(Actions.NAV, "lego_menu")
callback_data = cb.pack()  # "nav|lego_menu"

# –ü–∞—Ä—Å–∏–Ω–≥ callback
cb = parse_cb("nav|lego_menu")
print(cb.action)  # "nav"
print(cb.id)      # "lego_menu"
```

### –°—Ö–µ–º–∞ –º–µ–Ω—é (`menu_schema.py`)
```python
MENU = {
    "root": {
        "text_key": "menu.title",
        "buttons": [
            {"text_key": "btn.generate", "to": "modes", "cb": ("make",)},
            {"text_key": "btn.lego", "to": "lego_menu", "cb": ("lego",)},
        ],
    },
    # ...
}
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä (`keyboards.py`)
```python
from app.ui.keyboards import build_keyboard_with_description

# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
text, keyboard = build_keyboard_with_description("root")

# –¢–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
keyboard = build_keyboard("modes")
```

### –†–æ—É—Ç–µ—Ä (`router.py`)
```python
from app.handlers.router import on_action

@on_action("custom_action")
async def handle_custom_action(call, cb):
    await call.message.edit_text("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è")
```

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ callback-—ã —á–µ—Ä–µ–∑ –º–∞–ø–ø–∏–Ω–≥ –≤ `legacy_mapping.py`:

```python
# –°—Ç–∞—Ä—ã–π callback: "menu_make"
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤: Cb("make")

# –°—Ç–∞—Ä—ã–π callback: "back_home" 
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤: Cb("nav", "root")
```

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤

### 1. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç—ã –≤ `texts.py`
```python
"menu.new_screen": "–ù–æ–≤—ã–π —ç–∫—Ä–∞–Ω",
"btn.new_action": "–ù–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
```

### 2. –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª –≤ `menu_schema.py`
```python
"new_screen": {
    "text_key": "menu.new_screen",
    "buttons": [
        {"text_key": "btn.new_action", "to": "new_screen", "cb": ("new_action",)},
        {"text_key": "btn.back", "to": "root", "cb": ("nav", "root")},
    ],
},
```

### 3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö—ç–Ω–¥–ª–µ—Ä –≤ `router.py`
```python
@on_action("new_action")
async def handle_new_action(call, cb):
    await call.message.edit_text("–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è")
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
python3 test_ui_system.py
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã
```python
from app.ui.menu_schema import validate_menu_schema
errors = validate_menu_schema()
print(errors)  # [] –µ—Å–ª–∏ –≤—Å–µ OK
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ callback –¥–∞–Ω–Ω—ã—Ö
```python
from app.ui.callbacks import parse_cb
cb = parse_cb("nav|root")
assert cb.action == "nav"
assert cb.id == "root"
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `python3 scripts/dump_flow.py` —Å–æ–∑–¥–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã:

- `docs/flow.mmd` - –æ—Å–Ω–æ–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- `docs/flow_detailed.mmd` - –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å callback-–∞–º–∏
- `docs/callback_analysis.md` - –∞–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è callback-–æ–≤
- `docs/node_summary.md` - —Å–≤–æ–¥–∫–∞ –ø–æ —É–∑–ª–∞–º –º–µ–Ω—é

## –ú–∏–≥—Ä–∞—Ü–∏—è

### –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
```python
# –í main.py –¥–æ–±–∞–≤—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –æ–±–µ—Ä—Ç–∫—É
from app.handlers.router import callback_entry

async def migrated_callback_handler(update, context):
    try:
        await callback_entry(update.callback_query)
    except Exception:
        await old_on_cb(update, context)  # Fallback

app.add_handler(CallbackQueryHandler(migrated_callback_handler))
```

### –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
```python
# –ó–∞–º–µ–Ω–∏—Ç–µ –≤ create_app():
from app.handlers.router import register_router
register_router(app)  # –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. **–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å** - —Å—Ö–µ–º–∞ –º–µ–Ω—é –æ–ø–∏—Å–∞–Ω–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è** - –≤—Å–µ —Ç–µ–∫—Å—Ç—ã –∏ callback-—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å—Ö–µ–º—ã
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º
5. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
6. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö callback-–æ–≤
7. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —ç–∫—Ä–∞–Ω—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è
8. **–û—Ç–ª–∞–¥–∫–∞** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö callback-–æ–≤ –∏ –æ—à–∏–±–æ–∫

## Troubleshooting

### –û—à–∏–±–∫–∞ "Unknown action"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ö—ç–Ω–¥–ª–µ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `@on_action`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –µ—Å—Ç—å –≤ `Actions` –∫–ª–∞—Å—Å–µ

### –û—à–∏–±–∫–∞ "Callback data too long"
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–µ–∑–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ callback-—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –ù–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –º–µ–Ω—é
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —É–∑–µ–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `MENU`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `text_key` –µ—Å—Ç—å –≤ `texts.py`

### –°—Ç–∞—Ä—ã–µ callback-—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞–ø–ø–∏–Ω–≥ –≤ `legacy_mapping.py`
- –î–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–∞–ø–ø–∏–Ω–≥–∏

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã: `python3 test_ui_system.py`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
3. –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ —Å—Ö–µ–º—É: `validate_menu_schema()`
4. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: `python3 scripts/dump_flow.py`
