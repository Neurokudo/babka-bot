# üß© SECURITY AUDIT RULESET

## üéØ –¶–µ–ª—å
–ó–∞—â–∏—Ç–∞ –ª–æ–≥–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫, —Å–ø–∏—Å–∞–Ω–∏–π –∏ –º–æ–Ω–µ—Ç. Cursor –æ–±—è–∑–∞–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, YooKassa webhook, –±–∏–ª–ª–∏–Ω–≥–æ–º –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–æ—Å—Ç—É–ø–∞.

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞:

### 1. YooKassa
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `create_subscription` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø—Ä–∏** `payment.succeeded`.
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å `is_active=True`, –∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 30 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥.
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø—É—Ç–µ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏.

### 2. –ü–æ–¥–ø–∏—Å–∫–∏
- –õ—é–±–∞—è —Ñ—É–Ω–∫—Ü–∏—è `can_*` –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `is_active` –ø–æ–¥–ø–∏—Å–∫–∏.
- –§—É–Ω–∫—Ü–∏—è `can_spend()` –æ–±—è–∑–∞–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `False`, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞.
- –§—É–Ω–∫—Ü–∏—è `check_and_reset_expired_plans()` –¥–æ–ª–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –∏ –ø–æ cron.
- –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ `is_active` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `False`, –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –º–æ–Ω–µ—Ç–∫–∏.

### 3. –ú–æ–Ω–µ—Ç–∫–∏
- –õ—é–±–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ `charge_feature()` –∏–ª–∏ `spend_coins()`.
- `charge_feature()` –æ–±—è–∑–∞–Ω:
  - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–ª–∞–Ω—Å –∏ –ø–æ–¥–ø–∏—Å–∫—É.
  - –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Ç–∞–±–ª–∏—Ü—É `transactions`.
  - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `True/False` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º.
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å `can_generate_` –∏–ª–∏ `can_use_`, –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å `can_spend()`.

### 4. –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∞–¥–º–∏–Ω –Ω–µ –∏–º–µ–µ—Ç –æ–±—Ö–æ–¥–Ω—ã—Ö –ø—É—Ç–µ–π –∫ –ø–ª–∞—Ç–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º.
- –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –æ—Ç—á—ë—Ç—ã, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.

### 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ YooKassa ‚Äî Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
- –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å CTA –ø—Ä–æ–¥–ª–∏—Ç—å.

---

## üö® –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ Cursor

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤:
- `main.py`
- `billing.py`
- `yookassa_service.py`
- `queries.py`
- `subscriptions.py`
- `models.py`

Cursor –¥–æ–ª–∂–µ–Ω:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ `can_spend`, `charge_feature`, `create_subscription` –∏ `check_and_reset_expired_plans` –Ω–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –≤ —É—â–µ—Ä–± –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
2. –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–ª–∞—Ç–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏.
3. –ù–∞–ø–æ–º–Ω–∏—Ç—å –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞—É–¥–∏—Ç–∞ –ø–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∏–ª–ª–∏–Ω–≥–∞.

---

## üßæ –ò—Ç–æ–≥
–ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–ø–ª–æ–µ–º:
- –ü—Ä–æ–≥–Ω–∞—Ç—å –∞—É–¥–∏—Ç —Ñ—É–Ω–∫—Ü–∏–π `can_spend` –∏ `charge_feature`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ YooKassa webhook —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `payment.succeeded`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å `is_active` —Ñ–ª–∞–≥–∞ –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
