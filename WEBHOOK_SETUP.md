# üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook'–æ–≤ –¥–ª—è YooKassa

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ø–∞–¥–∞–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–¢–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ—Ç", –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π return_url –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö
2. –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook'–æ–≤ –æ—Ç YooKassa
3. –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ –≤ polling —Ä–µ–∂–∏–º–µ

## –†–µ—à–µ–Ω–∏–µ

### 1. –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è webhook'–æ–≤
–°–æ–∑–¥–∞–Ω `webhook_server.py` - Flask —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö –æ—Ç YooKassa.

**Endpoints:**
- `POST /webhook/yookassa` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
- `GET /health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- `GET /` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Procfile
```
web: python webhook_server.py
worker: python main.py
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã `/start payment_success` –≤ –±–æ—Ç–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã.

## –î–µ–ø–ª–æ–π

### Railway/Render
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ —É–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   - `YOOKASSA_SHOP_ID`
   - `YOOKASSA_SECRET_KEY`
   - `TELEGRAM_TOKEN`

2. –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø–æ–ª—É—á–∏—Ç–µ URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://your-app.railway.app`)

3. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa –¥–æ–±–∞–≤—å—Ç–µ webhook:
   ```
   URL: https://your-app.railway.app/webhook/yookassa
   –°–æ–±—ã—Ç–∏—è: payment.succeeded, payment.canceled
   ```

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
python start_local.py
```

–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ:
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: Webhook —Å–µ—Ä–≤–µ—Ä
python webhook_server.py

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: Telegram –±–æ—Ç
python main.py
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook —Å–µ—Ä–≤–µ—Ä–∞
```bash
curl https://your-app.railway.app/health
```

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
```json
{"status": "healthy", "service": "babka-bot-webhook"}
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
–í –±–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `/test_payment` –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

### 3. –õ–æ–≥–∏
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ webhook'–æ–≤.

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: Webhook —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –æ—Ç YooKassa –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç YooKassa.

3. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ü–ª–∞—Ç–µ–∂–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É.

4. **Fallback**: –ï—Å–ª–∏ webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–ª—É—á–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ return_url.

## Troubleshooting

### Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö YooKassa
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

### –ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è YOOKASSA_*
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook endpoint –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–º 200
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å—å webhook'–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –º–æ–Ω–µ—Ç—ã
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook'–æ–≤
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `handle_payment_webhook` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
